C UTEP Electronic Structure Lab (2020)
C
C ****************************************************************
C
      SUBROUTINE FLACUB(NARR,NR1,NR2,NPTS,R,WTS,NPHI,NTHET,RSPH,
     &                  RBOX,ERSPH,ERBOX,ALMIN,ALMAX,AFUDGE,NPOW)
C ORIGINAL VERSION BY MARK R PEDERSON (1989)
C
C FOR REGION OUTSIDE SPHERE BUT INSIDE CUBE:
C
C NARR:   SIZE OF R,WTS
C NR1:    RETURNED NUMBER OF RADIAL POINTS FROM 0 TO RSPH 
C NR2:    RETURNED NUMBER OF RADIAL POINTS FROM RSPH TO RMAX 
C R,WTS:  RETURNED COORDINATES AND WEIGHTS OF MESH POINTS
C NPHI:   NUMBER OF PHI POINTS FOR EXCLUDED CUBIC VOLUMES
C NTHET:  NUMBER OF THETA POINTS FOR EXCLUDED CUBIC VOLUMES
C RSPH:   RADIUS OF SPHERE 
C RBOX:   CUBE DEFINED BY |X|,|Y|,|Z| < RBOX
C ERSPH:  MAX. ERROR FOR RADIAL INTEGRATIONS FROM 0 TO RSPH
C ERBOX:  MAX. ERROR FOR RADIAL INTEGRATIONS FROM RSPH TO RBOX
C         AND FOR RADIAL INTEGRATIONS IN EXCLUDED VOLUME
C ALMIN:  MINIMUM EXPONENTIAL ALPHA
C ALMAX:  MAXIMUM EXPONENTIAL ALPHA
C AFUDGE: FACTOR BETWEEN SUCCESSIVE TEST ALPHAS
C NPOW:   MAX. POWER FOR TEST FUNCTIONS
C
C MXRAD:  MAXIMUM NUMBER OF POINTS FOR THE RADIAL MESH
C
       IMPLICIT REAL*8 (A-H,O-Z)
       PARAMETER (MXRAD=2000)  !FLOSIC Mesh 500 -> Sept Mesh 700 (0.1) -> 1200 (0.05) YY
       DIMENSION R(3,NARR),WTS(NARR)
       DIMENSION XRAD(MXRAD),WTRAD(MXRAD)
       SAVE
C
C CHECK ALMIN AND ALMAX 
C
       PI=4*ATAN(1.0D0)
       IF (ALMIN.GT.ALMAX) ALMAX= AFUDGE*ALMIN
C
C RADIAL MESH
C
       ZERO=0.0D0
       CALL RADMSH(MXRAD,ZERO,RSPH,ERSPH,ALMIN,ALMAX,AFUDGE,NPOW, 
     &             NR1,XRAD,WTRAD)
       NSTRT=NR1+1
       CALL RADMSH(MXRAD-NR1,RSPH,RBOX,ERBOX,ALMIN,ALMAX,AFUDGE,NPOW,
     &             NR2,XRAD(NSTRT),WTRAD(NSTRT))
       NRAD=NR1+NR2
       DO I=1,NRAD
        R(1,I)=XRAD(I)
        R(2,I)=0.0D0 
        R(3,I)=0.0D0 
        WTS(I)=(4*PI)*WTRAD(I)
       END DO
       NLEFT=NARR-NRAD
       NSTRT=NRAD+1
C
C EXCLUDED CUBIC REGIONS MESH
C
       CALL ATCUBE(NLEFT,NEXCL,R(1,NSTRT),WTS(NSTRT),NPHI,NTHET,
     &             RBOX,RBOX,ERBOX,ALMIN,ALMAX,AFUDGE,NPOW)
       NPTS=NRAD+NEXCL
       RETURN
      END
