C UTEP Electronic Structure Lab (2020)
      SUBROUTINE PAMLMSIC_GROUP(MODE,LSPN,LFM,MPTS,WMSA,SICP,RPTS)
#ifdef MPI
      use debug1
      use mpidat1,only : IRANK,SHM_SIZE,NCALLED_GRP,SHMRANK,SHMCOMM
      use SICMAT,only  : SIC_COL
      use FRM,only     : BFRM,RESULTS,LFRM
      USE XTMP2A,ONLY : ISMGGA,MIXINS
      use global_inputs,only : libxc1
! Conversion to implicit none.  Raja Zope Thu Aug 17 14:34:56 MDT 2017

!     INCLUDE  'PARAMAS'  
      INCLUDE  'PARAMA2'  
      INCLUDE 'mpif.h'
      INCLUDE 'commons.inc' 
      INTEGER :: IERR,IPROC,JOB,JWF,LFM,MPTS,NMAX,LSPN
      REAL*8 :: BUF,ADD0,ADD1,ADD2,ADD3,RPTS,SICP,WMSA
      PARAMETER (NMAX=MPBLOCK) 
      INTEGER TID,ITRANS(3),MODE,TAG
      INTEGER IRECVSTAT(MPI_STATUS_SIZE)
      DIMENSION WMSA(NMAX),SICP(NMAX),RPTS(3,NMAX)
      DIMENSION ADD1(NMAX),ADD2(NMAX),ADD3(3,NMAX),ADD0(3)
!     DIMENSION BUF(MAX_OCC)
CCC PUT ALL OF SICLGMATs specific common blocks here.
C     COMMON/MIXPOT/POTIN(MAX_PTS*MXSPN),POT(MAX_PTS*MXSPN)
C     COMMON/TMP1/COULOMB(MAX_PTS),RHOG(MAX_PTS,10,MXSPN)
C     COMMON/TMP2/PSIG(NMAX,10,MAX_OCC)
C    & ,PTS(NSPEED,3),GRAD(NSPEED,10,6,MAX_CON,3)
C    & ,RVECA(3,MX_GRP),ICOUNT(MAX_CON,3)
!      COMMON/SICMAT/SIC(MAX_OCC,MAX_OCC,MXSPN)
!      COMMON/FRM/BFRM(3,MAX_OCC,MXSPN),RESULTS(13, MAX_OCC,MXSPN),
!     &  LFRM(MXSPN),DEBDAX(3,MAX_OCC,MXSPN)

      IF (SHMRANK.NE.0) THEN
        WRITE(6+IRANK,*)'FATAL: PAMLMSIC_GRP CALLED BY WORKER'
        CALL STOPIT
      END IF
!      CALL TRACER('IN PAMLSIC MODE=',MODE)
      IF(MODE.EQ.1)THEN
        NCALLED_GRP=NCALLED_GRP+1
        CALL GTNTID_GRP(TID)
!        CALL TRACER('WORKER: IS ABOUT TO BE CALLED',TID)
        JOB=38 ! CHECK THIS
        TAG=0  ! I AM THE MANAGER (0)
        CALL MPI_SSEND(JOB,1,MPI_INTEGER,TID,TAG,SHMCOMM,IERR)
!        CALL TRACER('AFTER SEND')
        ITRANS(1)=LSPN
        ITRANS(2)=LFM
        ITRANS(3)=MPTS
        TAG=2401
C       PRINT*,IRANK,'PAM LFM IS ZERO:',LFM
        CALL MPI_SSEND(ITRANS(1),3,MPI_INTEGER,
     &                 TID,TAG,SHMCOMM,IERR)
        TAG=2402
        CALL MPI_SSEND(WMSA(1),NMAX,MPI_DOUBLE_PRECISION,
     &                 TID,TAG,SHMCOMM,IERR)
        TAG=2403
        CALL MPI_SSEND(SICP(1),NMAX,MPI_DOUBLE_PRECISION,
     &                 TID,TAG,SHMCOMM,IERR)
        TAG=2404
        CALL MPI_SSEND(RPTS(1,1),3*NMAX,MPI_DOUBLE_PRECISION,
     &                 TID,TAG,SHMCOMM,IERR)
        TAG=2405
        CALL MPI_SSEND(ISMGGA,1,MPI_LOGICAL,
     &                 TID,TAG,SHMCOMM,IERR)
        TAG=2406
        CALL MPI_SSEND(LIBXC1,1,MPI_LOGICAL,
     &                 TID,TAG,SHMCOMM,IERR)
        IF(ISMGGA.OR.LIBXC1)THEN
         TAG=2407
         CALL MPI_SSEND(MIXINS(1,1),4*NMAX,MPI_DOUBLE_PRECISION,
     &                  TID,TAG,SHMCOMM,IERR)
        ENDIF
C       PRINT*,'I AM RETURNING TO FRMORB',IRANK
        IF(NCALLED_GRP.EQ.SHM_SIZE)THEN
C         PRINT*,'WAITING FOR SOMEONE TO FINISH'
          CALL CKWORKER_GRP(4,TID)
C         PRINT*,'DONE WAITING'
        END IF  
      END IF
c=============================================
C     PRINT*,'MODE:',MODE
      IF (MODE .EQ. 2 ) THEN
C     PRINT*,'NCALLED:',NCALLED,'SHOULD BE ZERO'
        IF(NCALLED_GRP.NE.0)CALL STOPIT
        IF(LFM.EQ.0)THEN
          PRINT*,'LFM IS ZERO:',LFM
          CALL STOPIT
        END IF
!        CALL TRACER('SHM_SIZE',SHM_SIZE)
        DO IPROC=1,SHM_SIZE
!         CALL TRACER('IPROC',IPROC)
         JOB=39 ! CHECK THIS
         TAG=0  ! I AM THE MANAGER (0)
         CALL MPI_SSEND(JOB,1,MPI_INTEGER,IPROC,TAG,SHMCOMM,IERR)
        END DO
!        DO JWF=1,MAX_OCC
!          SIC(JWF,LFM,LSPN)= 0.0D0          
!        END DO
!        CALL TRACER('REDUCING SIC')
!        CALL MPI_BARRIER(SHMCOMM,IERR)
!        CALL MPI_REDUCE(SIC(1,LFM,LSPN),BUF(1),MAX_OCC,
!     &                   MPI_DOUBLE_PRECISION,MPI_SUM,0,
!     &                   SHMCOMM,IERR)
        CALL MPI_REDUCE(MPI_IN_PLACE,SIC_COL(1),MAX_OCC,
     &                   MPI_DOUBLE_PRECISION,MPI_SUM,0,
     &                   SHMCOMM,IERR)
!        DO JWF=1,MAX_OCC
!          SIC(JWF,LFM,LSPN)= SIC_COL(JWF)       
!        END DO
      END IF
#endif
      RETURN
      END
