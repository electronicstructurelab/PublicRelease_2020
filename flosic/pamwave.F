C UTEP Electronic Structure Lab (2020)
c
c *******************************************************************
c
      SUBROUTINE PAMWAVE(MODE,ISVD,IREP,NBAS)
C
C  SENDING BLOCKHAMILTONIANS TO WORKERS FOR DIAGGE
C  JK 09/99
C  MODE 1: LOOKING FOR A FREE NODE SENDING DATA
C  MODE 2: RECEIVING RESULTS OF DIAGGE
C
#ifdef MPI
      use common8,only : REP
      use mpidat1,only : NCALLED, IRANK, MPI_COMM_WORLD
! Conversion to implicit none.  Raja Zope Sun Aug 20 09:01:55 MDT 2017

!      INCLUDE  'PARAMAS'  
       INCLUDE  'PARAMA2'  
       INTEGER :: MPI_COMM_WORLD, ISVD, NBAS, NDH2
      INCLUDE 'mpif.h'
      SAVE       
      INTEGER MODE,IREP
      INTEGER TID,JOB,TAG,IERR,ITRANS(3),IRECVSTAT(MPI_STATUS_SIZE)         
c
c produce fatal error if I am a worker
c
      IF (IRANK.NE.0) THEN
       write(6,*)'FATAL: PAMWAVE CALLED BY WORKER'
       CALL STOPIT
      END IF
C
      IF (MODE.EQ.1) THEN
       NCALLED=NCALLED+1
       CALL GETTID(TID)
       JOB= 20
       TAG= 0
       CALL MPI_SSEND(JOB,1,MPI_INTEGER,TID,TAG,
     &     MPI_COMM_WORLD,IERR)
       TAG= 2000
       ITRANS(1)=IREP
       ITRANS(2)=ISVD
       ITRANS(3)=NBAS
       CALL MPI_SSEND(ITRANS(1),3,MPI_INTEGER,TID,TAG,
     &                MPI_COMM_WORLD,IERR)
       TAG= 2001
       NDH2=NDH*NBAS
       CALL MPI_SSEND(HAM(1,1),NDH2,MPI_DOUBLE_PRECISION,
     &                TID,TAG,MPI_COMM_WORLD,IERR)
       TAG= 2002
       CALL MPI_SSEND(OVER(1,1),NDH2,MPI_DOUBLE_PRECISION,
     &                TID,TAG,MPI_COMM_WORLD,IERR)
      END IF
c
c MODE = 2: RECEIVE RESULTS FROM DIAGGE
c
      IF (MODE.EQ.2) THEN
       TAG=1
       CALL MPI_RECV(TID,1,MPI_INTEGER,MPI_ANY_SOURCE,TAG,
     &               MPI_COMM_WORLD,IRECVSTAT,IERR)
       JOB= 21
       TAG= 0
       CALL MPI_SSEND(JOB,1,MPI_INTEGER,TID,TAG,
     &                MPI_COMM_WORLD,IERR)
       TAG=2100
       CALL MPI_RECV(ITRANS(1),2,MPI_INTEGER,
     &               TID,TAG,MPI_COMM_WORLD,IRECVSTAT,IERR)
       IREP=ITRANS(1)
       NBAS=ITRANS(2)
       NDH2=NDH*NBAS
       TAG= 2101
       CALL MPI_RECV(HAM(1,1),NDH2,MPI_DOUBLE_PRECISION,
     &               TID,TAG,MPI_COMM_WORLD,IRECVSTAT,IERR)
       TAG= 2102
       CALL MPI_RECV(OVER(1,1),NDH2,MPI_DOUBLE_PRECISION,
     &               TID,TAG,MPI_COMM_WORLD,IRECVSTAT,IERR)
       TAG= 2103
       CALL MPI_RECV(EVAL(1),NBAS,MPI_DOUBLE_PRECISION,
     &               TID,TAG,MPI_COMM_WORLD,IRECVSTAT,IERR)
 
       NCALLED=NCALLED-1
       CALL FREETID(TID)
      END IF
#endif
      RETURN
      END           
