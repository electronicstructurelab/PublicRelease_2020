C UTEP Electronic Structure Lab (2020)
C
C ********************************************************************
C
C CONSTRUCT MATRIX ELEMENTS OF POTENTIAL
C MARK PEDERSON AUG 1995
C
       SUBROUTINE PATCH(POTDV)
C
C WRITTEN BY MARK R PEDERSON 
C 02/12/97 David Clay Patton
C
       use xtmp2a,only  : PSIBR,PSIB,VOL,QR
       use mesh1,only   : NMSH
       use common5,only : PSI
       use common8,only : REP
! Conversion to implicit none.  Raja Zope Sun Aug 20 09:01:56 MDT 2017

!      INCLUDE  'PARAMAS'  
       INCLUDE  'PARAMA2'  
       INTEGER :: IERR, INDX, LPTS, MDCL, MPTS, NBAS, NMAX
       REAL*8 :: SYMBOL , POTDV
       SAVE
       PARAMETER (NMAX=MPBLOCK)
       DIMENSION POTDV(*)
C
C SCRATCH COMMON BLOCK FOR LOCAL ARRAYS
C ACUTALLY ARRAYS FROM COMMON BLOCK TMP2 ARE SHARED
C FROM MODULE TMP2A
C
C       COMMON/TMP2/PSIBR(MPBLOCK,5*NDH),PSIB(MPBLOCK)
C     &  ,VOL(MPBLOCK),QR(3,MPBLOCK)
       LOGICAL LSETUP
       DATA MDCL/2/
C
C GAM=   REPRESENATION INDEX, L=ROW OF REPRESENATION
C MDCL=1 CALCULATE MATRIX ELEMENTS BY ROTATING EACH MESH POINT TO 
C        EQUIVALENT POINTS AND FIND <PSI(I,GAM,L)|V(I)|PSI(I,GAM,L)> 
C        SUMMED OVER I WITH L=1
C MDCL=2 CALCULATE MATRIX ELEMENTS BY USING ONLY INEQUVIALENT POINTS
C        AND FIND <PSI(I,GAM,L)|V(I)|PSI(I,GAM,L)> SUMMED OVER I AND L
C
       IF (NMSH.GT.MAX_PTS) THEN
        write(6,*)'PATCH: MAX_PTS MUST BE AT LEAST', NMSH
        CALL STOPIT
       END IF
C
C ALLOCATE LOCAL ARRAYS
C
      ALLOCATE(PSIBR(MPBLOCK,5*NDH),STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR ALLOCATING PSIBR'
      ALLOCATE(PSIB(MPBLOCK),STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR ALLOCATING PSIB'
      ALLOCATE(VOL(MPBLOCK),STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR ALLOCATING VOL'
      ALLOCATE(QR(3,MPBLOCK),STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR ALLOCATING QR'

C
C      INITIALIZE ARRAY INDEX IN GETBAS
C
       LSETUP=.TRUE.
       CALL GETBAS(LSETUP,0,0,QR,PSIBR,0,NBAS)
C
       DO LPTS=0,NMSH-1,NMAX
        MPTS=MIN(NMAX,NMSH-LPTS)
        CALL HAMMAT(LPTS,MPTS,MDCL,POTDV,INDX) 
       END DO
C
C DEALLOCATE LOCAL ARRAYS
C
      DEALLOCATE(PSIBR,STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR DEALLOCATING PSIBR'
      DEALLOCATE(PSIB,STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR DEALLOCATING PSIB'
      DEALLOCATE(VOL,STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR DEALLOCATING VOL'
      DEALLOCATE(QR,STAT=IERR)
      IF(IERR/=0)WRITE(6,*)'HAMMAT:ERROR DEALLOCATING QR'

       RETURN 
       END
